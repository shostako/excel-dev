# 2025-12 作業ログ

## 2025-12-18 作業概要

### 実施内容

1. **Windows環境でのexcel-vba-expertスキル設定**
   - WSL側のスキルを確認（`\\wsl.localhost\Ubuntu-22.04\home\shostako\.claude\skills\excel-vba-expert\`）
   - Windows側のスキル（`C:\Users\shost\.claude\skills\excel-vba-expert\SKILL.md`）をWindows用パスに修正
   - 保存先: `/home/shostako/...` → `C:\Users\shost\ClaudeCode\excel-auto\src\`
   - 変換コマンド: `./scripts/bas2sjis` → `.\scripts\bas2sjis.ps1`

2. **VBAマクロレビュー・修正（9モジュール）**
   - mCommon.bas - 問題なし、そのまま採用
   - m完成品フィルター.bas - 修正
   - m項目フィルター.bas - 修正
   - m項目削除.bas - 修正
   - m項目追加.bas - 修正
   - m小部品フィルター.bas - 修正
   - m側板フィルター.bas - 修正
   - m日付表示.bas - 修正
   - mフィルター解除.bas - 修正

### 共通の修正内容

- **元の設定を保存** → 元の値で復元（固定値Trueではなく）
- **Cleanupラベル追加** → 設定復元コードを一箇所に集約
- **FindTableByPatternのNothingチェック追加**
- **AutoFilterオブジェクトの存在チェック追加**
- **エラー情報の詳細化**（errNum, errDesc変数使用）

### 技術的な学び

- Git Bash環境でPowerShellスクリプトを実行: `powershell.exe -File script.ps1`
- Shift-JISファイルの読み込み: `iconv -f SHIFT-JIS -t UTF-8 "file.bas"`
- WSLファイルへのアクセス: `\\wsl.localhost\ディストリビューション名\...`

### 出力ファイル

```
src/ (UTF-8)
├── mCommon.bas
├── m完成品フィルター.bas
├── m項目フィルター.bas
├── m項目削除.bas
├── m項目追加.bas
├── m小部品フィルター.bas
├── m側板フィルター.bas
├── m日付表示.bas
└── mフィルター解除.bas

macros/ (Shift-JIS) - Excelインポート用
└── 同上9ファイル
```

---

## 2025-12-18 追加作業

### 実施内容

1. **プロジェクト名変更**
   - `excel-auto` → `excel-dev` に統一
   - CLAUDE.md、PROGRESS.md を修正

2. **Mondayエージェント設定**
   - 場所: `~/.claude/agents/monday.md`（ユーザーレベル設定）
   - 25歳のドライなITアシスタント、タメ口・皮肉を交えた対話スタイル
   - プロジェクト横断で有効

3. **Claude Code設定の更新**
   - `.claude/settings.json` - hooks設定を新フォーマットに移行
   - `.mcp.json` - playwright MCP設定にcmdラッパー追加（Windows対応）

### 備考

- Monday設定はgitリポジトリ外（ユーザーレベル）のため、コミット対象外
- GitHub連携を実施予定

---

## 2025-12-18 Claude Code環境改善

### 問題

- Plan modeの切り替えショートカットが`Shift+Tab`ではなく`Alt+M`だった
- 操作性が悪い

### 調査結果

- **原因**: npm版とnative版でキーバインドが異なる
- **npm-global版**: `Alt+M`（Windows固有のワークアラウンド）
- **native installer版 (v2.0.31以降)**: `Shift+Tab`

### 参照したGitHub Issues

- [#3368](https://github.com/anthropics/claude-code/issues/3368) - Shift+Tab not working on Windows (47+👍)
- [#5885](https://github.com/anthropics/claude-code/issues/5885) - Mode switching shortcut inconsistency
- CHANGELOG.md - v2.0.31で修正記載

### 解決策

1. npm版をアンインストール: `npm uninstall -g @anthropic-ai/claude-code`
2. https://claude.ai/download からnative installerをダウンロード・インストール
3. `claude doctor`で`native`になっていることを確認

### 結果

- native版への切り替えで`Shift+Tab`が正常に動作
- 設定ディレクトリ（`~/.claude/`、プロジェクトの`.claude/`）は影響なし

### 教訓

- Windows環境のClaude Codeはインストール方法でキーバインドが異なる
- 公式ドキュメントに明記されていないため、Issue/CHANGELOGを調べる必要がある

---

## 2025-12-23 見出し改訂マクロ開発

### 概要

ISO文書管理用Excelファイルの表紙を一括整形するマクロ「m見出し改訂」を開発・改良。

### 実装した機能

1. **フォルダ一括処理**
   - 指定フォルダ内の.xls/.xlsx/.xlsmファイルを一括処理
   - 全シートを処理（2行目までにデータがあるシートのみ）

2. **元ファイル保管**
   - 「旧書式」サブフォルダに元ファイルをそのまま移動
   - 処理後ファイルは元の場所に元の名前で保存（.xlsx形式）

3. **事前チェック機能**
   - 同名で拡張子違いのファイル（test.xls と test.xlsx）を検出
   - 検出時は処理中止、一覧を表示

4. **保存前処理**
   - 全シートでA1選択、スクロール位置を左上にリセット
   - 最初のシートをアクティブに

5. **ログ出力**
   - シート「見出し改訂Log」に追記形式で記録
   - 列: ファイル名 / 変換前 / 変換後 / シート数 / フォルダパス
   - 列幅: 30 / 5 / 5 / 5 / 50
   - 縮小して全体を表示

6. **完了メッセージ**
   - Windows API `MessageBoxTimeout` で2秒後に自動消去

### 技術的なポイント

- **Windows API宣言**: VBA7対応（LongPtr/Long分岐）
- **FileSystemObject**: ファイル操作に使用
- **Dictionary**: 重複ファイル検出に使用

### ファイル

- `src/m見出し改訂.bas` (UTF-8)
- `macros/m見出し改訂.bas` (Shift-JIS、Excelインポート用)

---

## 2025-12-23 追加作業（印刷設定・日付書式）

### 実施内容

1. **ログ2行目空白問題** → 解決確認済み

2. **E7,E9の書式設定追加**（処理中座標、最終座標E2,E4）
   - フォントサイズ: 11
   - 日付書式: `yyyy"年"m"月"d"日"`

3. **印刷設定追加**（行削除後に設定）
   - 印刷範囲: B2:AK66
   - 余白: 左1cm、上下右0
   - ページ中央: 垂直・水平ともにTrue
   - 拡大縮小: 100%

### 備考

- 一度処理済みファイルを再処理するとおかしくなる（仕様通り）
- ユーザーが誤ってrevertを依頼→再度同じ修正を適用

---

## 2025-12-23 バグ修正（Dir()二重処理問題）

### 問題

最後のファイルで二重処理が発生。元ファイルと1回目処理後のファイルが両方「旧書式」フォルダに入り、2回目処理後のファイルが元の場所に残る。

### 原因

Dir()関数はループ中にフォルダ内容が変わると予期しない動作をする。処理中に`.xlsx`ファイルが作成され、それが`*.xls*`パターンにマッチして再度取得された。

### 修正内容

1. **Dir()ループ → Collection事前取得方式に変更**
   - 先にファイル一覧をCollectionに全て格納
   - その後For Eachでループ処理
   - ループ中のファイル変更の影響を受けない

2. **フォルダ名変更**
   - 「旧書式」→「■旧書式」

### 教訓

VBAのDir()関数でファイル処理する際は、ループ中にファイル作成・削除・リネームがある場合、必ず事前にファイル一覧を取得してからループすること。
