# 2026-01 作業ログ

## 2026-01-05 データ転送マクロ年別自動振り分け機能追加

### 作業概要

inboxに入れられたマクロ・クエリファイル群を分析し、データ転送システムの全体構成を把握。年末年始の年跨ぎ問題に対応するため、転送マクロと月別分割マクロを改修した。

### 実施内容

#### 1. システム分析
- ロット数量データ転送ADO、ゾーン別データ転送ADO、クエリ参照元変更、月別分割マクロの構造を把握
- Power Query（ロット数量ADO、不良集計ゾーン別ADO）の参照先を確認

#### 2. 転送マクロの年別自動振り分け機能追加
- 日付から年を抽出し、適切な年のDBファイルに自動振り分け
- 事前DBファイル存在チェック（All or Nothing方式）
- DBファイルがない場合はエラー表示してデータを残す（クリアしない）

新規追加関数:
- BuildDBPath: 年からDBパスを動的生成
- DBFileExists: DB存在チェック
- ExtractYearsFromData: データから年を抽出
- CheckAllDBsExist: 全DBファイル存在確認
- GroupRowsByYear: 年別行番号グループ化

#### 3. 月別分割マクロの年別対応
- mTransferYears.bas: Public変数で処理済み年リストを共有
- mRunAccess_月別分割.bas: 年リストを読んで各年のDBを処理

### Gitコミット
- `9d4ea15` feat: データ転送マクロに年別自動振り分け機能を追加
- `6a5fe73` feat: 月別分割マクロを年別対応に改修

### 技術的発見

#### rulesディレクトリの仕組み
- `.claude/rules/`の.mdファイルは自動的にコンテキストに読み込まれる
- しかし、rulesから参照された別ファイル（docs/excel-knowledge/等）は自動読み込みされない
- 「別ファイルを読め」という指示は仕組みとして機能しない（私が無視できるため）
- 解決策: docs/excel-knowledge/の必読内容をrules/に移動すべき

---

## 2026-01-05 rulesディレクトリ最適化・ナレッジベース整理

### 作業概要

前セッションで発見した「rulesから参照された別ファイルは自動読み込みされない」問題を解決。核心情報をrulesに統合し、冗長なナレッジファイルを削除。

### 実施内容

#### 1. rulesディレクトリ最適化

**削除**:
- `10-vba-required-reading.md`（「別ファイルを読め」は機能しない）

**拡充** (`11-vba-coding-standards.md`に追加):
- Activate禁止の理由・経緯（過去の失敗から）
- 症状診断フロー（もたもた→ScreenUpdating→Activate）
- 最適化の優先順位（黄金律）
- コメント標準（ヘッダー形式、段階別コメント、実例）

#### 2. docs/excel-knowledge/ 整理

**削除（rulesに統合済み）**:
- claude-code/EXCEL_MACRO_KNOWLEDGE_BASE.md
- claude-code/QUICK_REFERENCE.md
- patterns/VBA_OPTIMIZATION_PATTERNS.md
- techniques/VBA_BASIC_TECHNIQUES.md
- failures/001_activate_vs_screenupdating.md

**構造変更**:
- claude-code/ → examples/ にリネーム

**残存ファイル**:
- failures/005-008（個別失敗事例）
- m-language/M_LANGUAGE_BASICS.md
- examples/IMPLEMENTATION_EXAMPLES.md

### Gitコミット
- `8e39040` refactor: rulesディレクトリ最適化 - 機能しない参照指示を廃止
- `241577b` fix: コメント標準をrulesに追加（漏れ修正）
- `10a77e6` refactor: docs/excel-knowledge/を整理 - 冗長ファイル削除

### 技術的教訓

- rulesは自動読み込みされる = 核心情報を入れるべき場所
- docs/は参考資料 = 詳細な失敗ストーリーや実装例を残す場所
- 「別ファイルを読め」は仕組みとして機能しない

---

## 2026-01-05 UserForm日付入力の年末年始対応

### 作業概要

UserFormの日付入力で年末年始の年跨ぎ問題を解決。m/d形式で入力するとシステム日付の西暦が自動付与されるが、去年の日付を入力したい場合に対応できなかった。

### 問題

- 日付をm/d形式で入力 → CDate()がシステム日付の西暦を自動付与
- 年末年始に12/31と入力すると、今年の12/31と解釈される
- 本来は去年の12/31を入力したかった

### 解決策

表示形式を`yyyy/m/d`に変更。入力は従来通りm/dでもOK、明示的に西暦を変えたい場合はyyyy/m/dで入力。

### 実施内容

#### 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| CTextBoxEvent.cls | TB_Exit Case "Date": `Format(..., "yyyy/m/d")` |
| UserForm1.frm | TextBox1_Exit, CommandButton1_Click |
| UserForm2.frm | TextBox1_Exit, CommandButton1_Click |
| bas2sjis.ps1 | 拡張子を維持するように改修（.cls/.frm対応） |

#### 動作

1. `1/5` と入力 → `2026/1/5` に変換（システム日付の西暦を使用）
2. `2025/12/31` と入力 → `2025/12/31` のまま（明示的に指定した西暦を使用）

### 注意事項

- `.frx`ファイル（バイナリ）は変更なし
- TextBoxの横幅調整はユーザーがExcel VBEで実施

---

## 2026-01-07 UserFormテーブル名・列名参照エラー修正

### 作業概要

UserFormの「転送」ボタンを押すとエラーになる問題を修正。原因は前回改造時のテーブル名・列名の不一致。ルールに「参照名の確認（推測禁止）」を追加。

### 問題

- UserForm1: `_ロット数量全`テーブルを参照していたが、実際は`_ロット数量S`
- UserForm2: `_不良集計ゾーン別全`テーブルを参照、実際は`_不良集計ゾーン別S`
- UserForm2: `工程`列を参照、実際は`発見`列
- UserForm2: `戻めし`列を参照、実際は`差戻し`列

### 原因分析

前回の改造時に、別のUserFormのコードを参考にして「同じ名前だろう」と推測。対象テーブルの実際の列名を確認しなかった。

### 修正内容

| ファイル | 修正内容 |
|----------|----------|
| UserForm1.frm | `ロット数量全` → `ロット数量S`（8箇所） |
| UserForm2.frm | `不良集計ゾーン別全` → `不良集計ゾーン別S`（3箇所） |
| UserForm2.frm | `ListColumns("工程")` → `ListColumns("発見")` |
| UserForm2.frm | `ListColumns("戻めし")` → `ListColumns("差戻し")` |

### ルール追加

`12-vba-encoding.md`に「参照名の確認（推測禁止）」セクションを追加：

- コード内の参照名は推測ではなく実際の対象で確認する
- 「別のコードで同じ名前だったから」→ 危険
- 対象マクロ内のフィールド定義（targetFields等）を確認 → 安全

### 技術検証：Excel COM経由のボタン操作

デスクトップアプリ（Excel）の自動操作を試行：

- `$excel.Run('Sheet4.CommandButton1_Click')` でClickイベントハンドラを直接実行可能
- ただし、ボタンのCaptionが取得できず、どのボタンか特定が困難
- 結論：技術的には可能だが実用的ではない。手動操作の方が効率的

### 将来の自動化について

UserFormはUIレイヤー（人間向け）なので、Claudeがデータ入力を自動化する場合は：

- UserFormをバイパス
- テーブルのセルに直接書き込み（Excel COM経由）
- `$tbl.ListRows.Add` → `Range.Value2 = データ配列` で一括入力可能


---

## 2026-01-08 パワークエリ年間ファイル対応

### 作業概要

Accessファイルの肥大化分析結果を受けて、パワークエリを月別12ファイル分割運用から年間1ファイル運用に移行。

### 背景

- labのMondayからのレポート: Accessファイル肥大化の原因は「未コンパクト」だった
- コンパクト後: 20MB → 0.56MB（97%削減）
- 月別12ファイル分割は過剰対策だったことが判明

### 実施内容

#### 1. パワークエリ改修

| クエリ | Before | After |
|--------|--------|-------|
| 不良集計ゾーン別ADOクエリ | 前月+当月の2ファイル結合 | 年間1ファイル |
| ロット数量ADOクエリ | 同上 | 同上 |

#### 2. スキーマキャッシュ問題の解決

2025年のDBでクエリ実行時にエラー発生:
「Expression.Error: テーブルの列 '差戻し' が見つかりませんでした」

**原因調査**:
- OLEDBとDAOで分析 → 両年度のDB構造は完全に同一
- 「差戻し」列は存在し、データ型も同じ
- Power Queryのスキーマキャッシュが古い構造を記憶していた

**対策**:
- \ オプションを追加
- 列が見つからない場合でもnullで補完、後で0に置換



#### 3. 分析スクリプト作成

- Get-TableColumns.ps1: テーブルの列構成とNULL件数を確認
- Compare-TableFields.ps1: 2つのDBのフィールド定義を比較

### 技術的発見

- Power Queryはスキーマ情報をキャッシュする
- 列追加などのスキーマ変更後、キャッシュが古い情報を参照することがある
- キャッシュクリア: データ → クエリと接続 → データソースの設定 → アクセス許可のクリア
- 防御的コーディング: \ で将来の列追加にも対応

### 転送マクロについて

確認の結果、転送マクロ（mゾーン別データ転送ADO.bas）は既に年間ファイル対応済みだったため改修不要。

---

## 2026-01-08 月別分割マクロ進捗表示復元・重複確認削除

### 作業概要

年間1ファイル運用を検証した結果、パワークエリの読み込み速度が問題となり、月別12ファイル分割運用を継続することに決定。関連するマクロを調整。

### 方針変更の経緯

- 年間1ファイルだとパワークエリの読み込みが遅い
- 当月・前月の2ファイル結合が利便性最高
- Accessファイルのコンパクト化は有効（サイズ削減97%）
- 入力時のマクロ実行コストより閲覧時のクエリ速度を優先

### 実施内容

#### 1. 月別分割マクロ進捗表示復元

| 項目 | Before | After |
|------|--------|-------|
| 処理対象 | 年間ファイル（1ファイル/年） | 月別ファイル（12ファイル/年） |
| 進捗表示 | 「2025年を処理中...」 | 「2025年 1/12」〜「2025年 12/12」 |
| DBパス | 不良調査表DB-2025.accdb | 不良調査表DB-2025-01.accdb |

#### 2. ゾーン別転送マクロ重複確認機能削除

削除した機能：
- `existingDict` - 既存データ格納用Dictionary
- `keyFields` - 重複チェック用キーフィールド定義
- 日付範囲計算（minDate, maxDate, dateFilter）
- 既存データSELECTクエリとDictionaryロード処理
- `CreateKeyFromRow`補助関数

変更後の動作：
- 空白行スキップは維持
- 全ての非空白行を無条件でINSERT

#### 3. コンパイルエラー修正

- `monthNum As Long` → `monthNum As Integer`
- 原因: `BuildDBPath(..., monthValue As Integer)`とのByRef引数型不一致

### Gitコミット

- `0d5c65f` refactor: 月別分割マクロ進捗表示復元・ゾーン別転送重複確認削除

### 技術的教訓

- VBAのByRef引数は型が完全一致しないとコンパイルエラー
- `Long`から`Integer`への暗黙変換はByRefでは不可
- 年間ファイル vs 月別ファイルはユースケース次第（今回は閲覧速度優先）

---

## 2026-01-08 /vbaコマンド・セッションワークフロールール作成

### 作業概要

前回のマクロ生成でexcel-vba-expertスキルを使わずにドタバタした問題を受けて、仕組みで解決。また、セッション開始時に親プロジェクトのPROGRESS.mdを誤って読んだ問題も対策。

### 問題1: スキル呼び忘れ

- excel-vba-expertスキルがあるのに使わなかった
- 口約束では解決しない

### 解決策1: /vbaコマンド作成

`~/.claude/commands/vba.md` を新規作成:

1. 処理概要を聞く（自然言語でOK）
2. 選択肢を提示:
   - A: これで生成開始（情報十分なら）
   - B: 追加情報を伝える
3. 追加情報収集（Bの場合のみ）
4. 参考マクロ読み込み（あれば）
5. **excel-vba-expertスキル呼び出し**（必須）
6. マクロ生成

柔軟なフロー: 「重複判定なくして」程度の簡潔な指示なら即Aで生成へ

### 問題2: 進捗確認で親プロジェクトを読んだ

- gitStatusを見ればexcel-autoにいることは明らか
- なのに親（ClaudeCode）のPROGRESS.mdを読んでしまった

### 解決策2: セッションワークフロールール追加

`~/.claude/rules/01-session-workflow.md` を新規作成:

- 進捗確認時は**カレントディレクトリのPROGRESS.md**を読む
- gitStatusの最近のコミット内容を見て判断
- cwdを確認せずに決め打ちで読むな

### 技術的教訓

- 口約束より仕組みで解決
- ルールに書いても実行されるとは限らない → コマンド化で確実に発動
- グローバルルール（~/.claude/rules/）は全プロジェクトに効く

---

## 2026-01-10 廃棄転記マクロ改修

### 作業概要

inboxに入れられた廃棄転記マクロ3つ（加工H/成形H/塗装H）を分析し、4つの改修を実施。

### マクロ構造の把握

3つのマクロはほぼ同一構造：
- ソース: シート「廃棄」テーブル「_廃棄」、シート「ロット数量」テーブル「_ロット数量」
- 出力: 期間別 × 9品番（8品番＋補給品）の集計テーブル
- 機能: ワースト順出力、合計列、空白期間スキップ、印刷範囲設定

違いは工程フィルタ（加工/成形/塗装）とテーブルスタイルのみ。

### 実施内容

#### 1. ソートアルゴリズム統一

| マクロ | Before | After |
|--------|--------|-------|
| 加工H | QuickSort | QuickSort（変更なし） |
| 成形H | **BubbleSort** | **QuickSort** |
| 塗装H | QuickSort | QuickSort（変更なし） |

QuickSortはO(n log n)、BubbleSortはO(n²)。データ量が少ないため体感差はないが、コードの一貫性のため統一。

#### 2. 空白期間対応（hasData削除）

Before: `hasData = False`の場合`GoTo NextPeriod`でスキップ
After: データがなくてもテーブル構造を出力

出力されるようになった内容：
- ヘッダー行（項目, 58050FrLH, ..., 補給品, 合計）
- ショット数行（全て0でもOK）
- 不良数行（全て0でもOK）
- 不良内容項目行はデータがある場合のみ

#### 3. 期間テーブル空白行スキップ

**問題**: 期間テーブルに6行あり、期間1のみ日付入力、期間2〜6は空白。
結果、出力テーブルが「12/30〜12/30」という謎の日付で複数出力された。

**原因**: 
- Excelの空白セル = 数値の`0`
- `CDate(0)` = **1899年12月30日**（Excelの日付シリアル値0）
- `Format(CDate(0), "m/d")` = **"12/30"**

**対策**: 期間テーブル読み込み時に3重チェック
```vba
If Not IsEmpty(startVal) And Not IsEmpty(endVal) Then      ' 空白でない
    If IsDate(startVal) And IsDate(endVal) Then            ' 日付として有効
        If CDbl(startVal) <> 0 And CDbl(endVal) <> 0 Then  ' シリアル値0でない
            ' 有効な期間として処理
        End If
    End If
End If
```

#### 4. 変数重複宣言エラー修正

**問題**: 期間テーブル読み込みで追加した`Dim idx As Long`が、既存の`Dim idx As Long`（totalArrループ用）と衝突してコンパイルエラー。

**対策**: 期間テーブル部分の`idx`を`pIdx`（period index）に変更。

### Gitコミット

- `7bb1cb1` feat: 廃棄転記マクロ改修（加工H/成形H/塗装H）

### 技術的発見

- VBAでは同一プロシージャ内で同名変数を2回宣言するとコンパイルエラー
- Excelの空白セルは数値0として扱われ、CDate(0)は1899年12月30日
- IsEmpty()で空白判定、IsDate()で日付判定、CDbl() <> 0でシリアル値0を除外
