# 2026-01 作業ログ

## 2026-01-05 データ転送マクロ年別自動振り分け機能追加

### 作業概要

inboxに入れられたマクロ・クエリファイル群を分析し、データ転送システムの全体構成を把握。年末年始の年跨ぎ問題に対応するため、転送マクロと月別分割マクロを改修した。

### 実施内容

#### 1. システム分析
- ロット数量データ転送ADO、ゾーン別データ転送ADO、クエリ参照元変更、月別分割マクロの構造を把握
- Power Query（ロット数量ADO、不良集計ゾーン別ADO）の参照先を確認

#### 2. 転送マクロの年別自動振り分け機能追加
- 日付から年を抽出し、適切な年のDBファイルに自動振り分け
- 事前DBファイル存在チェック（All or Nothing方式）
- DBファイルがない場合はエラー表示してデータを残す（クリアしない）

新規追加関数:
- BuildDBPath: 年からDBパスを動的生成
- DBFileExists: DB存在チェック
- ExtractYearsFromData: データから年を抽出
- CheckAllDBsExist: 全DBファイル存在確認
- GroupRowsByYear: 年別行番号グループ化

#### 3. 月別分割マクロの年別対応
- mTransferYears.bas: Public変数で処理済み年リストを共有
- mRunAccess_月別分割.bas: 年リストを読んで各年のDBを処理

### Gitコミット
- `9d4ea15` feat: データ転送マクロに年別自動振り分け機能を追加
- `6a5fe73` feat: 月別分割マクロを年別対応に改修

### 技術的発見

#### rulesディレクトリの仕組み
- `.claude/rules/`の.mdファイルは自動的にコンテキストに読み込まれる
- しかし、rulesから参照された別ファイル（docs/excel-knowledge/等）は自動読み込みされない
- 「別ファイルを読め」という指示は仕組みとして機能しない（私が無視できるため）
- 解決策: docs/excel-knowledge/の必読内容をrules/に移動すべき

---

## 2026-01-05 rulesディレクトリ最適化・ナレッジベース整理

### 作業概要

前セッションで発見した「rulesから参照された別ファイルは自動読み込みされない」問題を解決。核心情報をrulesに統合し、冗長なナレッジファイルを削除。

### 実施内容

#### 1. rulesディレクトリ最適化

**削除**:
- `10-vba-required-reading.md`（「別ファイルを読め」は機能しない）

**拡充** (`11-vba-coding-standards.md`に追加):
- Activate禁止の理由・経緯（過去の失敗から）
- 症状診断フロー（もたもた→ScreenUpdating→Activate）
- 最適化の優先順位（黄金律）
- コメント標準（ヘッダー形式、段階別コメント、実例）

#### 2. docs/excel-knowledge/ 整理

**削除（rulesに統合済み）**:
- claude-code/EXCEL_MACRO_KNOWLEDGE_BASE.md
- claude-code/QUICK_REFERENCE.md
- patterns/VBA_OPTIMIZATION_PATTERNS.md
- techniques/VBA_BASIC_TECHNIQUES.md
- failures/001_activate_vs_screenupdating.md

**構造変更**:
- claude-code/ → examples/ にリネーム

**残存ファイル**:
- failures/005-008（個別失敗事例）
- m-language/M_LANGUAGE_BASICS.md
- examples/IMPLEMENTATION_EXAMPLES.md

### Gitコミット
- `8e39040` refactor: rulesディレクトリ最適化 - 機能しない参照指示を廃止
- `241577b` fix: コメント標準をrulesに追加（漏れ修正）
- `10a77e6` refactor: docs/excel-knowledge/を整理 - 冗長ファイル削除

### 技術的教訓

- rulesは自動読み込みされる = 核心情報を入れるべき場所
- docs/は参考資料 = 詳細な失敗ストーリーや実装例を残す場所
- 「別ファイルを読め」は仕組みとして機能しない
