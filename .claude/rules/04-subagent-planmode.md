# サブエージェント・Plan Mode運用ルール

## サブエージェント機能活用方針

**検証済み**: 2025-11-07にGemini提供情報をファクトチェック完了

### 基本方針

- **大規模調査**: Exploreサブエージェントに委任（10.8倍の効率化）
- **独立タスク**: 並列実行で処理（1.8倍の効率化）
- **簡単な調査**: 直接実行（速度優先）

### 使用推奨場面

- コードベースの分析: Explore (medium)
- 複数ファイルの確認: Explore (quick)
- 新機能の実装計画: Plan (sonnet)
- ドキュメント全体の見直し: 4x Explore並列

### サブエージェントへのコンテキスト転送

**制約**: サブエージェントには親のコンテキストが自動で渡らない
- 会話履歴、CLAUDE.md、フック設定は引き継がれない
- 親が指示文に書いた内容のみがサブエージェントに伝わる
- 長文の指示はトークン制限で切り詰められる可能性あり

**対策**: 必要な情報はファイルパスで渡し、サブに読ませる
```
まず .claude/rules/ を読んでから [タスク] を実行しろ
まず docs/spec.md を確認してから [調査内容] を調べろ
```

サブエージェント側でReadできるため、トークン制限の影響を回避できる。

### 詳細ガイド

- **公式リファレンス**: `docs/claude-code-references/`

---

## Plan Mode運用ルール

**重要**: Plan Modeは計画確認のために有用だが、調査フェーズでの効率化が必要。

### Plan Modeの価値（維持すべき）

- 計画を立ててユーザー確認を取る
- 一気に実装せず、段階的に進める
- 予期しない変更を防ぐ

### Plan Mode内での調査方法

**読み取り専用操作は直接実行**（サブエージェント不要）：
- `cat`, `head`, `tail`（ファイル表示）
- `ls`（ファイル一覧）
- `grep`（検索）

**理由**：
- サブエージェントは最新設定（フック等）を知らない
- サブエージェントは実行を避けて推測する傾向
- 直接実行の方が速く正確（10秒 vs 2分以上）

**サブエージェントを使うべき調査**：
- 複数ファイルにまたがる構造分析
- コードベース全体の理解が必要な調査
- 複雑な依存関係の調査

### 理想的なフロー

```
ユーザー: 「○○して」
    ↓
Plan mode開始
    ↓
直接ファイル読む（10秒）← サブエージェント不要
    ↓
計画立案
    ↓
ExitPlanModeで計画提示
    ↓
ユーザー: 「OK」or「開始」
    ↓
実装
```
