# VBAコーディング標準

## 出力形式ルール

### VBAマクロ生成

- **形式**: 直接ファイル作成（.basファイル）
- **保存先**: `src/`ディレクトリ
- **コメント**: 日本語
- **完了メッセージ**: エラー時以外は表示しない
- **エンコーディング**: UTF-8（変換スクリプトでShift-JIS化）
- **重要**: srcに保存後、**必ずbas2sjisスクリプトを実行**してmacrosに出力すること

### Power Query (M言語) 生成

- **形式**: 直接ファイル作成（.pq または .txt）
- **保存先**: `src/`ディレクトリ
- **コメント**: 日本語
- **エンコーディング**: UTF-8のまま（変換不要）
- **必須手順**: srcに保存後、**macrosフォルダにコピー**すること
  ```powershell
  Copy-Item src/クエリ名.pq macros/
  ```

### 関数・数式生成

- **形式**: 通常メッセージ内に記載
- **説明**: 日本語で使用方法を説明

---

## コーディング標準

### エラーハンドリング

```vba
Sub 処理名()
    Application.StatusBar = "処理を開始します..."

    On Error GoTo ErrorHandler

    ' メインの処理

    Application.StatusBar = False
    Exit Sub

ErrorHandler:
    Application.StatusBar = False
    MsgBox "エラーが発生しました: " & Err.Description & vbCrLf & _
           "エラー番号: " & Err.Number, vbCritical
End Sub
```

### 進捗表示

- **ステータスバー使用**: 必須（長時間処理時）
- **更新頻度**: 100件ごと、または処理段階ごと
- **クリア方法**: `Application.StatusBar = False`
- **注意**: 専用のクリアマクロは作らない

### モジュール命名規則

- **接頭辞**: `m` を付ける（例: `m日別集計_モールFR別`）
- **命名**: 日本語可、アンダースコア区切り

---

## 重要な制約事項

### 画面更新の抑制について

- `Application.ScreenUpdating = False` は**積極的に使用する**（高速化の基本）
- CommandButtonから呼び出される場合の注意点：
  - 個別マクロの最後で`True`に戻さない（CommandButtonに任せる）
  - 重複設定は無害なので気にしない
- **絶対に使わない：`Activate`メソッド**
  - これが画面ちらつきの真犯人
  - データ処理にシート切り替えは不要
  - オブジェクト参照で直接操作すること

#### なぜActivateが禁止なのか（過去の失敗から）

**症状**: 画面がちらつく、もたもた動く、セルが一つずつ更新される

**間違った診断**: 「二重ループが原因だ！」→ Dictionary実装
**真の原因**: **Activateメソッドが諸悪の根源**

```vba
' これが真犯人
ws.Activate  ' ← 画面がパタパタする元凶
Range("A1").Select  ' ← これも悪い
Selection.Value = "データ"  ' ← 最悪

' 正しい書き方
ws.Range("A1").Value = "データ"  ' オブジェクト参照で直接操作
```

**教訓**: 「賢い解決策（Dictionary）より、正しい解決策（Activate排除）を選べ」

#### 症状診断フロー

```
もたもた・ちらつき
    ↓
ScreenUpdating = False 確認
    ↓
Activate/Select を探して削除
    ↓
それでもダメならアルゴリズム
```

#### 最適化の優先順位（黄金律）

1. **画面制御**（ScreenUpdating = False）
2. **Activate/Select排除**
3. **計算制御**（Calculation = Manual）
4. **配列処理**
5. **アルゴリズム改善**

### メッセージ表示

- **正常終了時**: メッセージボックス表示なし
- **エラー時のみ**: MsgBoxで詳細表示
- **進捗**: ステータスバーのみ使用

### データ処理の最適化

- 配列処理を優先（Range操作の最小化）
- Dictionaryオブジェクトの活用
- 大量データ時は進捗表示必須

---

## デバッグ支援

### Debug.Print活用

- 日付変換エラーなどの警告出力
- 本番環境でも残しておく（イミディエイトウィンドウ確認用）

### エラー情報の詳細化

- エラー番号とDescription両方を表示
- 可能な限り発生箇所を特定できる情報を含める

---

## 思考プロセスの活用（Claude標準thinking機能）

### 概要

- Claude標準の内部思考機能を活用
- ユーザーには見えない思考プロセスで問題を整理
- sequential-thinkingツールは使わない（重いため）

### 使用推奨場面

- **複雑なデータ構造設計**: テーブル間の関係性整理
- **アルゴリズム最適化**: 複数の処理方法の比較
- **エラー原因の特定**: 段階的な問題の切り分け
- **曖昧な仕様の明確化**: 要件の整理と確認事項の洗い出し

### 効果的な活用

- グループ化ロジックの設計前
- 日付・時間処理の妥当性検証
- パフォーマンスボトルネックの特定
- エラーハンドリング戦略の決定
